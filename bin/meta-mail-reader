#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative '../lib/meta/mail_reader'

REQUIRED_ENV_KEYS = %w[AWS_SECRET_KEY AWS_ACCESS_KEY S3_BUCKET_NAME].freeze
REQUIRED_ENV_KEYS.each do |name|
  unless ENV.key? name
    raise 'The following environment keys are required: ' \
      "#{REQUIRED_ENV_KEYS.join ', '}"
  end
end

imap_host = ENV['IMAP_HOST'] || 'imap.gmail.com'
imap_port = ENV['IMAP_PORT'] || 993
username  = ENV['IMAP_USERNAME'] || raise('IMAP_USERNAME is missing')
password  = ENV['IMAP_PASSWORD'] || raise('IMAP_PASSWORD is missing')

# Initialize the Mail library.
Mail.defaults do
  retriever_method(
    :imap,
    address: imap_host,
    port: imap_port,
    user_name: username,
    password: password,
    enable_ssl: true
  )
end

attachment_root_dir = File.join Dir.pwd, 'data'

mail_reader = Meta::MailReader::Client.new attachment_root_dir: attachment_root_dir
mail_handler = Meta::MailReader::Handler.new

mail_reader.on :attachment do |mail, attachment, attachment_path|
  mail_handler.new_attachment mail, attachment, attachment_path
end

if $PROGRAM_NAME == __FILE__
  loop do
    mail_reader.poll

    sleep 15
  end
end
